{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Create a Generic Server [1.8.1]",
  "Parameters": {
    "InternalSG": {
      "Description": "Security Group ID",
      "Type": "String",
      "Default": "sg-00000000",
      "AllowedPattern": "sg-[0-9a-f]{8}",
      "ConstraintDescription": "a valid aws security group id"
    },
    "ExternalSG": {
      "Description": "Security Group ID",
      "Type": "String",
      "Default": "sg-00000000",
      "AllowedPattern": "sg-[0-9a-f]{8}",
      "ConstraintDescription": "a valid aws security group id"
    },
    "AppSG": {
      "Description": "Security Group ID",
      "Type": "String",
      "Default": "sg-00000000",
      "AllowedPattern": "sg-[0-9a-f]{8}",
      "ConstraintDescription": "a valid aws security group id"
    },
    "Subnet": {
      "Description": "Subnet Id",
      "Type": "String",
      "Default": "subnet-00000000",
      "AllowedPattern": "subnet-[0-9a-f]{8}",
      "ConstraintDescription": "a valid aws subnet id"
    },
    "AppInstanceProfile": {
      "Type": "String",
      "Description": "string"
    },
    "ChefRoles": {
      "Type": "String",
      "Description": "comma separated list of Chef roles"
    },
    "ChefEnv": {
      "Type": "String",
      "Description": "string"
    },
    "ChefServerURL": {
      "Type": "String",
      "Description": "string"
    },
    "ChefOrg": {
      "Type": "String",
      "Description": "string"
    },
    "ChefProxyURL": {
      "Type": "String",
      "Description": "string"
    },
    "InstanceAMI": {
      "Description": "Machine Image",
      "Type": "String",
      "Default": "ami-00000000",
      "AllowedPattern": "ami-[0-9a-f]{8}",
      "ConstraintDescription": "a valid aws image id"
    },
    "AppInstanceType": {
      "Description": "EC2 Instance Type",
      "Type": "String",
      "Default": "m1.medium",
      "AllowedValues": [
        "t1.micro",
        "t2.micro",
        "t2.small",
        "t2.medium",
        "t2.large",
        "m1.small",
        "m1.medium",
        "m1.large",
        "m1.xlarge",
        "m2.xlarge",
        "m2.2xlarge",
        "m2.4xlarge",
        "m3.medium",
        "m3.large",
        "m3.xlarge",
        "m3.2xlarge",
        "m4.large",
        "m4.xlarge",
        "m4.2xlarge",
        "m4.4xlarge",
        "m4.10xlarge",
        "c1.medium",
        "c1.xlarge",
        "c3.large",
        "c3.xlarge",
        "c3.2xlarge",
        "c3.4xlarge",
        "c3.8xlarge",
        "c4.large",
        "c4.xlarge",
        "c4.2xlarge",
        "c4.4xlarge",
        "c4.8xlarge",
        "cc1.4xlarge",
        "cc2.8xlarge",
        "cg1.4xlarge",
        "cr1.8xlarge",
        "d2.xlarge",
        "d2.2xlarge",
        "d2.4xlarge",
        "d2.8xlarge",
        "g2.2xlarge",
        "g2.8xlarge",
        "hi1.4xlarge",
        "hs1.8xlarge",
        "i2.xlarge",
        "i2.2xlarge",
        "i2.4xlarge",
        "i2.8xlarge",
        "r3.large",
        "r3.xlarge",
        "r3.2xlarge",
        "r3.4xlarge",
        "r3.8xlarge"
      ],
      "ConstraintDescription": "a valid EC2 instance type."
    },
    "RootDiskSize": {
      "Description": "Disk Size (gb)",
      "Default": "12",
      "Type": "Number",
      "MinValue": "0",
      "MaxValue": "2000"
    },
    "RootDiskDevice": {
      "Type": "String",
      "Default": "/dev/sda1",
      "Description": "string"
    },
    "OptDiskSize": {
      "Description": "Disk Size (gb)",
      "Default": "0",
      "Type": "Number",
      "MinValue": "0",
      "MaxValue": "2000"
    },
    "OptDiskDevice": {
      "Type": "String",
      "Default": "/dev/xvdf",
      "Description": "string"
    },
    "ClusterPG": {
      "Type": "String",
      "Description": "EC2 Placement group for instances in ClusterPG",
      "Default": "none"
    },
    "PrivateIP": {
      "Description": "IPv4 Address",
      "Type": "String",
      "Default": "none",
      "AllowedPattern": "none|([0-9]{1,3}\\.){3}[0-9]{1,3}",
      "ConstraintDescription": "an ipv4 address"
    },
    "Tenancy": {
      "Type": "String",
      "Description": "Tenancy for EC2 Instance",
      "Default": "none",
      "AllowedValues": [
        "none",
        "dedicated"
      ]
    },
    "EphemeralDevList": {
      "Type": "CommaDelimitedList",
      "Description": "device names for ephemeral mounts",
      "Default": "/dev/xvdb,/dev/xvdc,/dev/xvdd,/dev/xvde,/dev/xvdf,/dev/xvdg,/dev/xvdh,/dev/xvdi"
    },
    "MaxProvisionTime": {
      "Default": "1500",
      "Description": "Provision wait time (s)",
      "Type": "Number",
      "MinValue": "0",
      "MaxValue": "3600"
    },
    "Volume1": {
      "Type": "CommaDelimitedList",
      "Default": "0, standard, none, none, 0",
      "Description": "Attached Volume Info"
    },
    "Volume2": {
      "Type": "CommaDelimitedList",
      "Default": "0, standard, none, none, 0",
      "Description": "Attached Volume Info"
    },
    "Volume3": {
      "Type": "CommaDelimitedList",
      "Default": "0, standard, none, none, 0",
      "Description": "Attached Volume Info"
    },
    "Volume4": {
      "Type": "CommaDelimitedList",
      "Default": "0, standard, none, none, 0",
      "Description": "Attached Volume Info"
    },
    "Volume5": {
      "Type": "CommaDelimitedList",
      "Default": "0, standard, none, none, 0",
      "Description": "Attached Volume Info"
    },
    "Volume6": {
      "Type": "CommaDelimitedList",
      "Default": "0, standard, none, none, 0",
      "Description": "Attached Volume Info"
    },
    "Volume7": {
      "Type": "CommaDelimitedList",
      "Default": "0, standard, none, none, 0",
      "Description": "Attached Volume Info"
    },
    "Volume8": {
      "Type": "CommaDelimitedList",
      "Default": "0, standard, none, none, 0",
      "Description": "Attached Volume Info"
    },
    "Volume9": {
      "Type": "CommaDelimitedList",
      "Default": "0, standard, none, none, 0",
      "Description": "Attached Volume Info"
    },
    "Volume10": {
      "Type": "CommaDelimitedList",
      "Default": "0, standard, none, none, 0",
      "Description": "Attached Volume Info"
    },
    "Volume11": {
      "Type": "CommaDelimitedList",
      "Default": "0, standard, none, none, 0",
      "Description": "Attached Volume Info"
    },
    "Volume12": {
      "Type": "CommaDelimitedList",
      "Default": "0, standard, none, none, 0",
      "Description": "Attached Volume Info"
    },
    "NodeName": {
      "Type": "String",
      "Default": "test",
      "Description": "string"
    },
    "NodeIndex": {
      "Type": "String",
      "Default": "01",
      "Description": "string"
    },
    "AssignEIP": {
      "Description": "",
      "Type": "String",
      "Default": "False",
      "AllowedValues": [
        "False",
        "True"
      ]
    },
    "PrivateCNAME": {
      "Description": "Route53 CNAME",
      "Type": "String",
      "Default": "none",
      "AllowedPattern": "none|[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]",
      "ConstraintDescription": "a DNS CNAME"
    },
    "PublicCNAME": {
      "Description": "Route53 CNAME",
      "Type": "String",
      "Default": "none",
      "AllowedPattern": "none|[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]",
      "ConstraintDescription": "a DNS CNAME"
    },
    "OpsAlertsTopic": {
      "Type": "String",
      "Description": "string"
    },
    "KeyPair": {
      "Description": "",
      "Type": "String",
      "Default": "no-key",
      "MinLength": "1",
      "MaxLength": "64",
      "AllowedPattern": "[-_ a-zA-Z0-9]*",
      "ConstraintDescription": "a valid key"
    },
    "PublicBucketName": {
      "Description": "S3 Bucket Name",
      "Type": "String",
      "AllowedPattern": "[-A-Za-z0-9.]{2,64}",
      "ConstraintDescription": "a S3 bucket name"
    },
    "PrivateBucketName": {
      "Description": "S3 Bucket Name",
      "Type": "String",
      "AllowedPattern": "[-A-Za-z0-9.]{2,64}",
      "ConstraintDescription": "a S3 bucket name"
    },
    "BootPriority": {
      "Description": "Boot Priority Level",
      "Type": "Number",
      "Default": "2",
      "MinValue": "0"
    },
    "Purpose": {
      "Description": "Instance Purpose",
      "Type": "String",
      "Default": "component",
      "AllowedPattern": "[A-Za-z0-9_-]+"
    },
    "ExtraHelper": {
      "Type": "String",
      "Default": "none",
      "Description": "Additional Bootstrap Helper"
    },
    "Domain": {
      "Description": "app domain",
      "Type": "String",
      "Default": "chubsre.dev.cloud.synchronoss.net",
      "AllowedPattern": "[-A-Za-z0-9.]+\\.[A-Za-z]{2,4}",
      "ConstraintDescription": "a domain"
    },
    "Environment": {
      "Type": "String",
      "Default": "NOENVIRONMENT",
      "Description": "environment"
    },
    "Project": {
      "Type": "String",
      "Default": "NOPROJECT",
      "Description": "project"
    }
  },
  "Conditions": {
    "NeedsOptVolume": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "OptDiskSize"
            },
            "0"
          ]
        }
      ]
    },
    "NeedsEIP": {
      "Fn::Equals": [
        {
          "Ref": "AssignEIP"
        },
        "True"
      ]
    },
    "NeedsPrivateCNAME": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "PrivateCNAME"
            },
            "none"
          ]
        }
      ]
    },
    "NeedsPublicCNAME": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "PublicCNAME"
            },
            "none"
          ]
        }
      ]
    },
    "UsePlacementGroup": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "ClusterPG"
            },
            "none"
          ]
        }
      ]
    },
    "UseTenancy": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "Tenancy"
            },
            "none"
          ]
        }
      ]
    },
    "UsePrivateIp": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "PrivateIP"
            },
            "none"
          ]
        }
      ]
    },
    "NeedsVolume1": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume1"
                }
              ]
            },
            "0"
          ]
        }
      ]
    },
    "Volume1UsesIops": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume1"
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "1",
                {
                  "Ref": "Volume1"
                }
              ]
            },
            "io1"
          ]
        }
      ]
    },
    "Volume1IsStandard": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume1"
        },
        {
          "Fn::Not": [
            {
              "Condition": "Volume1UsesIops"
            }
          ]
        }
      ]
    },
    "NeedsVolume2": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume2"
                }
              ]
            },
            "0"
          ]
        }
      ]
    },
    "Volume2UsesIops": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume2"
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "1",
                {
                  "Ref": "Volume2"
                }
              ]
            },
            "io1"
          ]
        }
      ]
    },
    "Volume2IsStandard": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume2"
        },
        {
          "Fn::Not": [
            {
              "Condition": "Volume2UsesIops"
            }
          ]
        }
      ]
    },
    "NeedsVolume3": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume3"
                }
              ]
            },
            "0"
          ]
        }
      ]
    },
    "Volume3UsesIops": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume3"
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "1",
                {
                  "Ref": "Volume3"
                }
              ]
            },
            "io1"
          ]
        }
      ]
    },
    "Volume3IsStandard": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume3"
        },
        {
          "Fn::Not": [
            {
              "Condition": "Volume3UsesIops"
            }
          ]
        }
      ]
    },
    "NeedsVolume4": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume4"
                }
              ]
            },
            "0"
          ]
        }
      ]
    },
    "Volume4UsesIops": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume4"
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "1",
                {
                  "Ref": "Volume4"
                }
              ]
            },
            "io1"
          ]
        }
      ]
    },
    "Volume4IsStandard": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume4"
        },
        {
          "Fn::Not": [
            {
              "Condition": "Volume4UsesIops"
            }
          ]
        }
      ]
    },
    "NeedsVolume5": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume5"
                }
              ]
            },
            "0"
          ]
        }
      ]
    },
    "Volume5UsesIops": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume5"
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "1",
                {
                  "Ref": "Volume5"
                }
              ]
            },
            "io1"
          ]
        }
      ]
    },
    "Volume5IsStandard": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume5"
        },
        {
          "Fn::Not": [
            {
              "Condition": "Volume5UsesIops"
            }
          ]
        }
      ]
    },
    "NeedsVolume6": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume6"
                }
              ]
            },
            "0"
          ]
        }
      ]
    },
    "Volume6UsesIops": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume6"
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "1",
                {
                  "Ref": "Volume6"
                }
              ]
            },
            "io1"
          ]
        }
      ]
    },
    "Volume6IsStandard": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume6"
        },
        {
          "Fn::Not": [
            {
              "Condition": "Volume6UsesIops"
            }
          ]
        }
      ]
    },
    "NeedsVolume7": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume7"
                }
              ]
            },
            "0"
          ]
        }
      ]
    },
    "Volume7UsesIops": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume7"
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "1",
                {
                  "Ref": "Volume7"
                }
              ]
            },
            "io1"
          ]
        }
      ]
    },
    "Volume7IsStandard": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume7"
        },
        {
          "Fn::Not": [
            {
              "Condition": "Volume7UsesIops"
            }
          ]
        }
      ]
    },
    "NeedsVolume8": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume8"
                }
              ]
            },
            "0"
          ]
        }
      ]
    },
    "Volume8UsesIops": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume8"
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "1",
                {
                  "Ref": "Volume8"
                }
              ]
            },
            "io1"
          ]
        }
      ]
    },
    "Volume8IsStandard": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume8"
        },
        {
          "Fn::Not": [
            {
              "Condition": "Volume8UsesIops"
            }
          ]
        }
      ]
    },
    "NeedsVolume9": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume9"
                }
              ]
            },
            "0"
          ]
        }
      ]
    },
    "Volume9UsesIops": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume9"
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "1",
                {
                  "Ref": "Volume9"
                }
              ]
            },
            "io1"
          ]
        }
      ]
    },
    "Volume9IsStandard": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume9"
        },
        {
          "Fn::Not": [
            {
              "Condition": "Volume9UsesIops"
            }
          ]
        }
      ]
    },
    "NeedsVolume10": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume10"
                }
              ]
            },
            "0"
          ]
        }
      ]
    },
    "Volume10UsesIops": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume10"
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "1",
                {
                  "Ref": "Volume10"
                }
              ]
            },
            "io1"
          ]
        }
      ]
    },
    "Volume10IsStandard": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume10"
        },
        {
          "Fn::Not": [
            {
              "Condition": "Volume10UsesIops"
            }
          ]
        }
      ]
    },
    "NeedsVolume11": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume11"
                }
              ]
            },
            "0"
          ]
        }
      ]
    },
    "Volume11UsesIops": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume11"
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "1",
                {
                  "Ref": "Volume11"
                }
              ]
            },
            "io1"
          ]
        }
      ]
    },
    "Volume11IsStandard": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume11"
        },
        {
          "Fn::Not": [
            {
              "Condition": "Volume11UsesIops"
            }
          ]
        }
      ]
    },
    "NeedsVolume12": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume12"
                }
              ]
            },
            "0"
          ]
        }
      ]
    },
    "Volume12UsesIops": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume12"
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "1",
                {
                  "Ref": "Volume12"
                }
              ]
            },
            "io1"
          ]
        }
      ]
    },
    "Volume12IsStandard": {
      "Fn::And": [
        {
          "Condition": "NeedsVolume12"
        },
        {
          "Fn::Not": [
            {
              "Condition": "Volume12UsesIops"
            }
          ]
        }
      ]
    },
    "MustWait": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "MaxProvisionTime"
            },
            "0"
          ]
        }
      ]
    }
  },
  "Resources": {
    "Server": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "InstanceType": {
          "Ref": "AppInstanceType"
        },
        "IamInstanceProfile": {
          "Ref": "AppInstanceProfile"
        },
        "KeyName": {
          "Ref": "KeyPair"
        },
        "SubnetId": {
          "Ref": "Subnet"
        },
        "SecurityGroupIds": [
          {
            "Ref": "InternalSG"
          },
          {
            "Ref": "AppSG"
          },
          {
            "Ref": "ExternalSG"
          }
        ],
        "SourceDestCheck": "True",
        "PlacementGroupName": {
          "Fn::If": [
            "UsePlacementGroup",
            {
              "Ref": "ClusterPG"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Tenancy": {
          "Fn::If": [
            "UseTenancy",
            {
              "Ref": "ClusterPG"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "PrivateIpAddress": {
          "Fn::If": [
            "UsePrivateIp",
            {
              "Ref": "PrivateIP"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "ImageId": {
          "Ref": "InstanceAMI"
        },
        "BlockDeviceMappings": [
          {
            "DeviceName": {
              "Fn::Select": [
                "0",
                {
                  "Ref": "EphemeralDevList"
                }
              ]
            },
            "VirtualName": "ephemeral0"
          },
          {
            "DeviceName": {
              "Fn::Select": [
                "1",
                {
                  "Ref": "EphemeralDevList"
                }
              ]
            },
            "VirtualName": "ephemeral1"
          },
          {
            "DeviceName": {
              "Fn::Select": [
                "2",
                {
                  "Ref": "EphemeralDevList"
                }
              ]
            },
            "VirtualName": "ephemeral2"
          },
          {
            "DeviceName": {
              "Fn::Select": [
                "3",
                {
                  "Ref": "EphemeralDevList"
                }
              ]
            },
            "VirtualName": "ephemeral3"
          },
          {
            "DeviceName": {
              "Fn::Select": [
                "4",
                {
                  "Ref": "EphemeralDevList"
                }
              ]
            },
            "VirtualName": "ephemeral4"
          },
          {
            "DeviceName": {
              "Fn::Select": [
                "5",
                {
                  "Ref": "EphemeralDevList"
                }
              ]
            },
            "VirtualName": "ephemeral5"
          },
          {
            "DeviceName": {
              "Fn::Select": [
                "6",
                {
                  "Ref": "EphemeralDevList"
                }
              ]
            },
            "VirtualName": "ephemeral6"
          },
          {
            "DeviceName": {
              "Fn::Select": [
                "7",
                {
                  "Ref": "EphemeralDevList"
                }
              ]
            },
            "VirtualName": "ephemeral7"
          },
          {
            "DeviceName": {
              "Ref": "RootDiskDevice"
            },
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootDiskSize"
              },
              "VolumeType": "gp2"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash",
                "\n",
                "",
                "\n",
                "exec > >(tee /var/log/userdata.log | logger -t userdata -s 2>/dev/console) 2>&1",
                "\n",
                "",
                "\n",
                "export HOME=/root",
                "\n",
                "export PATH=$PATH:/usr/local/sbin",
                "\n",
                "",
                "\n",
                "logger -s -t userdata 'create the environment descriptor file'",
                "\n",
                "",
                "\n",
                "SNCR_AWS_ENV='/usr/local/etc/sncr-aws-env.sh'",
                "\n",
                "",
                "\n",
                "cat <<EOF > $SNCR_AWS_ENV",
                "\n",
                "DOMAIN='",
                {
                  "Ref": "Domain"
                },
                "'",
                "\n",
                "NODENAME='",
                {
                  "Ref": "NodeName"
                },
                "'",
                "\n",
                "NODEINDEX='",
                {
                  "Ref": "NodeIndex"
                },
                "'",
                "\n",
                "PRIVATEBUCKET='",
                {
                  "Ref": "PrivateBucketName"
                },
                "'",
                "\n",
                "PUBLICBUCKET='",
                {
                  "Ref": "PublicBucketName"
                },
                "'",
                "\n",
                "PROJECT_NAME='",
                {
                  "Ref": "Project"
                },
                "'",
                "\n",
                "PROJECT_ENV='",
                {
                  "Ref": "Environment"
                },
                "'",
                "\n",
                "AWS_REGION='",
                {
                  "Ref": "AWS::Region"
                },
                "'",
                "\n",
                "OPS_ALERTS_TOPIC='",
                {
                  "Ref": "OpsAlertsTopic"
                },
                "'",
                "\n",
                "CHEF_ENV='",
                {
                  "Ref": "ChefEnv"
                },
                "'",
                "\n",
                "CHEF_ROLES='",
                {
                  "Ref": "ChefRoles"
                },
                "'",
                "\n",
                "CHEF_ORG='",
                {
                  "Ref": "ChefOrg"
                },
                "'",
                "\n",
                "CHEF_SERVER='",
                {
                  "Ref": "ChefServerURL"
                },
                "'",
                "\n",
                "CHEF_PROXY='",
                {
                  "Ref": "ChefProxyURL"
                },
                "'",
                "\n",
                "EXTRA_HELPER='",
                {
                  "Ref": "ExtraHelper"
                },
                "'",
                "\n",
                "CF_WAIT_HANDLE='",
                {
                  "Ref": "WaitHandle"
                },
                "'",
                "\n",
                "",
                "\n",
                "export DOMAIN NODENAME NODEINDEX",
                "\n",
                "export PRIVATEBUCKET PUBLICBUCKET",
                "\n",
                "export PROJECT_NAME PROJECT_ENV",
                "\n",
                "export AWS_REGION",
                "\n",
                "export OPS_ALERTS_TOPIC",
                "\n",
                "export CHEF_ENV CHEF_ROLES CHEF_ORG CHEF_SERVER CHEF_PROXY",
                "\n",
                "export CF_WAIT_HANDLE",
                "\n",
                "EOF",
                "\n",
                "",
                "\n",
                "chmod 0644 $SNCR_AWS_ENV",
                "\n",
                "chown root:root $SNCR_AWS_ENV",
                "\n",
                ". $SNCR_AWS_ENV",
                "\n",
                "",
                "\n",
                "yum update --security -y",
                "\n",
                "",
                "\n",
                "cd /usr/local/sbin",
                "\n",
                "",
                "\n",
                "logger -s -t userdata 'fetch the helper scripts'",
                "\n",
                "helpers='configure-network.sh mount-disks.sh install-awscli.sh install-chef-client.sh signal-wait-handle.sh sncr-aws-versions.sh'",
                "\n",
                "",
                "\n",
                "if [ -z \"$EXTRA_HELPER\" ]; then",
                "\n",
                "  EXTRA_HELPER=\"none\"",
                "\n",
                "fi",
                "\n",
                "",
                "\n",
                "if [ \"$EXTRA_HELPER\" != \"none\" ]; then",
                "\n",
                "  helpers=\"$helpers $EXTRA_HELPER\"",
                "\n",
                "fi",
                "\n",
                "",
                "\n",
                "",
                "\n",
                "for helper in $helpers; do",
                "\n",
                "  logger -s -t userdata \"Fetching $helper\"",
                "\n",
                "  wget http://${PUBLICBUCKET}.s3.amazonaws.com/public/$helper",
                "\n",
                "  chmod 0544 $helper",
                "\n",
                "  chown root:root $helper",
                "\n",
                "done",
                "\n",
                "",
                "\n",
                "logger -s -t userdata 'move the versions file to /usr/local/etc'",
                "\n",
                "mv -f sncr-aws-versions.sh /usr/local/etc",
                "\n",
                "",
                "\n",
                "install-awscli.sh",
                "\n",
                "mount-disks.sh",
                "\n",
                "configure-network.sh",
                "\n",
                "if [ \"$EXTRA_HELPER\" != \"none\" ]; then",
                "\n",
                "  $EXTRA_HELPER",
                "\n",
                "fi",
                "\n",
                "",
                "\n",
                "install-chef-client.sh",
                "\n",
                "",
                "\n",
                "rc=$?",
                "\n",
                "signal-wait-handle.sh $rc \"install-chef-client ${NODENAME}${NODEINDEX}\"",
                "\n",
                "",
                "\n",
                "echo \"Initiating a reboot\"",
                "\n",
                "sync",
                "\n",
                "sync",
                "\n",
                "reboot",
                "\n"
              ]
            ]
          }
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  }
                ]
              ]
            }
          },
          {
            "Key": "BootPriority",
            "Value": {
              "Ref": "BootPriority"
            }
          },
          {
            "Key": "Purpose",
            "Value": {
              "Ref": "Purpose"
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "OptVolume": {
      "Type": "AWS::EC2::Volume",
      "Condition": "NeedsOptVolume",
      "Properties": {
        "Size": {
          "Ref": "OptDiskSize"
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":/opt"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "OptMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "NeedsOptVolume",
      "Properties": {
        "VolumeId": {
          "Ref": "OptVolume"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Ref": "OptDiskDevice"
        }
      }
    },
    "Volume1Standard": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume1IsStandard",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume1"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume1"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume1"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume1Iops": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume1UsesIops",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume1"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume1"
            }
          ]
        },
        "Iops": {
          "Fn::Select": [
            "4",
            {
              "Ref": "Volume1"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume1"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume1IOPSMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume1UsesIops",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume1Iops"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume1"
            }
          ]
        }
      }
    },
    "Volume1StandardMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume1IsStandard",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume1Standard"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume1"
            }
          ]
        }
      }
    },
    "Volume2Standard": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume2IsStandard",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume2"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume2"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume2"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume2Iops": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume2UsesIops",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume2"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume2"
            }
          ]
        },
        "Iops": {
          "Fn::Select": [
            "4",
            {
              "Ref": "Volume2"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume2"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume2IOPSMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume2UsesIops",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume2Iops"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume2"
            }
          ]
        }
      }
    },
    "Volume2StandardMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume2IsStandard",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume2Standard"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume2"
            }
          ]
        }
      }
    },
    "Volume3Standard": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume3IsStandard",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume3"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume3"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume3"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume3Iops": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume3UsesIops",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume3"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume3"
            }
          ]
        },
        "Iops": {
          "Fn::Select": [
            "4",
            {
              "Ref": "Volume3"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume3"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume3IOPSMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume3UsesIops",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume3Iops"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume3"
            }
          ]
        }
      }
    },
    "Volume3StandardMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume3IsStandard",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume3Standard"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume3"
            }
          ]
        }
      }
    },
    "Volume4Standard": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume4IsStandard",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume4"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume4"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume4"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume4Iops": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume4UsesIops",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume4"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume4"
            }
          ]
        },
        "Iops": {
          "Fn::Select": [
            "4",
            {
              "Ref": "Volume4"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume4"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume4IOPSMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume4UsesIops",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume4Iops"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume4"
            }
          ]
        }
      }
    },
    "Volume4StandardMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume4IsStandard",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume4Standard"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume4"
            }
          ]
        }
      }
    },
    "Volume5Standard": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume5IsStandard",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume5"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume5"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume5"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume5Iops": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume5UsesIops",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume5"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume5"
            }
          ]
        },
        "Iops": {
          "Fn::Select": [
            "4",
            {
              "Ref": "Volume5"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume5"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume5IOPSMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume5UsesIops",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume5Iops"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume5"
            }
          ]
        }
      }
    },
    "Volume5StandardMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume5IsStandard",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume5Standard"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume5"
            }
          ]
        }
      }
    },
    "Volume6Standard": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume6IsStandard",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume6"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume6"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume6"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume6Iops": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume6UsesIops",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume6"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume6"
            }
          ]
        },
        "Iops": {
          "Fn::Select": [
            "4",
            {
              "Ref": "Volume6"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume6"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume6IOPSMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume6UsesIops",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume6Iops"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume6"
            }
          ]
        }
      }
    },
    "Volume6StandardMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume6IsStandard",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume6Standard"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume6"
            }
          ]
        }
      }
    },
    "Volume7Standard": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume7IsStandard",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume7"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume7"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume7"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume7Iops": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume7UsesIops",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume7"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume7"
            }
          ]
        },
        "Iops": {
          "Fn::Select": [
            "4",
            {
              "Ref": "Volume7"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume7"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume7IOPSMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume7UsesIops",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume7Iops"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume7"
            }
          ]
        }
      }
    },
    "Volume7StandardMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume7IsStandard",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume7Standard"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume7"
            }
          ]
        }
      }
    },
    "Volume8Standard": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume8IsStandard",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume8"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume8"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume8"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume8Iops": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume8UsesIops",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume8"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume8"
            }
          ]
        },
        "Iops": {
          "Fn::Select": [
            "4",
            {
              "Ref": "Volume8"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume8"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume8IOPSMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume8UsesIops",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume8Iops"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume8"
            }
          ]
        }
      }
    },
    "Volume8StandardMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume8IsStandard",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume8Standard"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume8"
            }
          ]
        }
      }
    },
    "Volume9Standard": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume9IsStandard",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume9"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume9"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume9"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume9Iops": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume9UsesIops",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume9"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume9"
            }
          ]
        },
        "Iops": {
          "Fn::Select": [
            "4",
            {
              "Ref": "Volume9"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume9"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume9IOPSMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume9UsesIops",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume9Iops"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume9"
            }
          ]
        }
      }
    },
    "Volume9StandardMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume9IsStandard",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume9Standard"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume9"
            }
          ]
        }
      }
    },
    "Volume10Standard": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume10IsStandard",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume10"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume10"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume10"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume10Iops": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume10UsesIops",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume10"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume10"
            }
          ]
        },
        "Iops": {
          "Fn::Select": [
            "4",
            {
              "Ref": "Volume10"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume10"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume10IOPSMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume10UsesIops",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume10Iops"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume10"
            }
          ]
        }
      }
    },
    "Volume10StandardMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume10IsStandard",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume10Standard"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume10"
            }
          ]
        }
      }
    },
    "Volume11Standard": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume11IsStandard",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume11"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume11"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume11"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume11Iops": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume11UsesIops",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume11"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume11"
            }
          ]
        },
        "Iops": {
          "Fn::Select": [
            "4",
            {
              "Ref": "Volume11"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume11"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume11IOPSMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume11UsesIops",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume11Iops"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume11"
            }
          ]
        }
      }
    },
    "Volume11StandardMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume11IsStandard",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume11Standard"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume11"
            }
          ]
        }
      }
    },
    "Volume12Standard": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume12IsStandard",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume12"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume12"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume12"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume12Iops": {
      "Type": "AWS::EC2::Volume",
      "Condition": "Volume12UsesIops",
      "Properties": {
        "VolumeType": {
          "Fn::Select": [
            "1",
            {
              "Ref": "Volume12"
            }
          ]
        },
        "Size": {
          "Fn::Select": [
            "0",
            {
              "Ref": "Volume12"
            }
          ]
        },
        "Iops": {
          "Fn::Select": [
            "4",
            {
              "Ref": "Volume12"
            }
          ]
        },
        "AvailabilityZone": {
          "Fn::GetAtt": [
            "Server",
            "AvailabilityZone"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "NodeName"
                  },
                  {
                    "Ref": "NodeIndex"
                  },
                  ":",
                  {
                    "Fn::Select": [
                      "3",
                      {
                        "Ref": "Volume12"
                      }
                    ]
                  }
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "project",
            "Value": {
              "Ref": "Project"
            }
          }
        ]
      }
    },
    "Volume12IOPSMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume12UsesIops",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume12Iops"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume12"
            }
          ]
        }
      }
    },
    "Volume12StandardMount": {
      "Type": "AWS::EC2::VolumeAttachment",
      "Condition": "Volume12IsStandard",
      "Properties": {
        "VolumeId": {
          "Ref": "Volume12Standard"
        },
        "InstanceId": {
          "Ref": "Server"
        },
        "Device": {
          "Fn::Select": [
            "2",
            {
              "Ref": "Volume12"
            }
          ]
        }
      }
    },
    "AppEIP": {
      "Type": "AWS::EC2::EIP",
      "Condition": "NeedsEIP",
      "Properties": {
        "InstanceId": {
          "Ref": "Server"
        },
        "Domain": "vpc"
      }
    },
    "AppEIPRecord": {
      "Type": "AWS::Route53::RecordSet",
      "Condition": "NeedsEIP",
      "Properties": {
        "Comment": "",
        "HostedZoneName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "Domain"
              },
              "."
            ]
          ]
        },
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Ref": "NodeName"
                    },
                    {
                      "Ref": "NodeIndex"
                    },
                    "-eip"
                  ]
                ]
              },
              ".",
              {
                "Ref": "Domain"
              },
              "."
            ]
          ]
        },
        "Type": "A",
        "TTL": "300",
        "ResourceRecords": [
          {
            "Ref": "AppEIP"
          }
        ]
      }
    },
    "AppPrivateAddrRecord": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "Comment": "",
        "HostedZoneName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "Domain"
              },
              "."
            ]
          ]
        },
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Ref": "NodeName"
                    },
                    {
                      "Ref": "NodeIndex"
                    }
                  ]
                ]
              },
              ".",
              {
                "Ref": "Domain"
              },
              "."
            ]
          ]
        },
        "Type": "A",
        "TTL": "300",
        "ResourceRecords": [
          {
            "Fn::GetAtt": [
              "Server",
              "PrivateIp"
            ]
          }
        ]
      }
    },
    "AppPrivateCNAME": {
      "Type": "AWS::Route53::RecordSet",
      "Condition": "NeedsPrivateCNAME",
      "Properties": {
        "Comment": "",
        "HostedZoneName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "Domain"
              },
              "."
            ]
          ]
        },
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "PrivateCNAME"
              },
              ".",
              {
                "Ref": "Domain"
              },
              "."
            ]
          ]
        },
        "Type": "CNAME",
        "TTL": "300",
        "ResourceRecords": [
          {
            "Fn::Join": [
              "",
              [
                {
                  "Ref": "NodeName"
                },
                {
                  "Ref": "NodeIndex"
                },
                ".",
                {
                  "Ref": "Domain"
                }
              ]
            ]
          }
        ]
      }
    },
    "AppPublicCNAME": {
      "Type": "AWS::Route53::RecordSet",
      "Condition": "NeedsPublicCNAME",
      "Properties": {
        "Comment": "",
        "HostedZoneName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "Domain"
              },
              "."
            ]
          ]
        },
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "PublicCNAME"
              },
              ".",
              {
                "Ref": "Domain"
              },
              "."
            ]
          ]
        },
        "Type": "CNAME",
        "TTL": "300",
        "ResourceRecords": [
          {
            "Fn::Join": [
              "",
              [
                {
                  "Ref": "NodeName"
                },
                {
                  "Ref": "NodeIndex"
                },
                "-eip.",
                {
                  "Ref": "Domain"
                }
              ]
            ]
          }
        ]
      }
    },
    "WaitHandle": {
      "Type": "AWS::CloudFormation::WaitConditionHandle"
    },
    "WaitCondition": {
      "Type": "AWS::CloudFormation::WaitCondition",
      "Condition": "MustWait",
      "DependsOn": "Server",
      "Properties": {
        "Handle": {
          "Ref": "WaitHandle"
        },
        "Timeout": {
          "Ref": "MaxProvisionTime"
        }
      }
    },
    "AppCPUAlarmHigh": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmDescription": "cpu ? 80% for 2 300 second periods",
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/EC2",
        "Statistic": "Average",
        "Threshold": "80",
        "Period": "300",
        "EvaluationPeriods": "2",
        "AlarmActions": [
          {
            "Ref": "OpsAlertsTopic"
          }
        ],
        "Dimensions": [
          {
            "Name": "InstanceId",
            "Value": {
              "Ref": "Server"
            }
          }
        ],
        "ComparisonOperator": "GreaterThanThreshold"
      }
    }
  },
  "Outputs": {
    "ServerWaitResult": {
      "Condition": "MustWait",
      "Value": {
        "Fn::GetAtt": [
          "WaitCondition",
          "Data"
        ]
      },
      "Description": "Reported Wait Data"
    },
    "Server": {
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Ref": "NodeName"
            },
            {
              "Ref": "NodeIndex"
            }
          ]
        ]
      },
      "Description": "Name"
    },
    "RootVolume": {
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Ref": "RootDiskSize"
            },
            "GB as ",
            {
              "Ref": "RootDiskDevice"
            },
            " mounted on /"
          ]
        ]
      },
      "Description": "Root Volume"
    },
    "OptVolume": {
      "Condition": "NeedsOptVolume",
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Ref": "OptDiskSize"
            },
            "GB as /dev/xvdf mounted on /opt"
          ]
        ]
      },
      "Description": "Opt Volume"
    },
    "Volume1": {
      "Condition": "NeedsVolume1",
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume1"
                }
              ]
            },
            "GB as ",
            {
              "Fn::Select": [
                "2",
                {
                  "Ref": "Volume1"
                }
              ]
            },
            " mounted on ",
            {
              "Fn::Select": [
                "3",
                {
                  "Ref": "Volume1"
                }
              ]
            }
          ]
        ]
      },
      "Description": "Volume1"
    },
    "Volume2": {
      "Condition": "NeedsVolume2",
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume2"
                }
              ]
            },
            "GB as ",
            {
              "Fn::Select": [
                "2",
                {
                  "Ref": "Volume2"
                }
              ]
            },
            " mounted on ",
            {
              "Fn::Select": [
                "3",
                {
                  "Ref": "Volume2"
                }
              ]
            }
          ]
        ]
      },
      "Description": "Volume2"
    },
    "Volume3": {
      "Condition": "NeedsVolume3",
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume3"
                }
              ]
            },
            "GB as ",
            {
              "Fn::Select": [
                "2",
                {
                  "Ref": "Volume3"
                }
              ]
            },
            " mounted on ",
            {
              "Fn::Select": [
                "3",
                {
                  "Ref": "Volume3"
                }
              ]
            }
          ]
        ]
      },
      "Description": "Volume3"
    },
    "Volume4": {
      "Condition": "NeedsVolume4",
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume4"
                }
              ]
            },
            "GB as ",
            {
              "Fn::Select": [
                "2",
                {
                  "Ref": "Volume4"
                }
              ]
            },
            " mounted on ",
            {
              "Fn::Select": [
                "3",
                {
                  "Ref": "Volume4"
                }
              ]
            }
          ]
        ]
      },
      "Description": "Volume4"
    },
    "Volume5": {
      "Condition": "NeedsVolume5",
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume5"
                }
              ]
            },
            "GB as ",
            {
              "Fn::Select": [
                "2",
                {
                  "Ref": "Volume5"
                }
              ]
            },
            " mounted on ",
            {
              "Fn::Select": [
                "3",
                {
                  "Ref": "Volume5"
                }
              ]
            }
          ]
        ]
      },
      "Description": "Volume5"
    },
    "Volume6": {
      "Condition": "NeedsVolume6",
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume6"
                }
              ]
            },
            "GB as ",
            {
              "Fn::Select": [
                "2",
                {
                  "Ref": "Volume6"
                }
              ]
            },
            " mounted on ",
            {
              "Fn::Select": [
                "3",
                {
                  "Ref": "Volume6"
                }
              ]
            }
          ]
        ]
      },
      "Description": "Volume6"
    },
    "Volume7": {
      "Condition": "NeedsVolume7",
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume7"
                }
              ]
            },
            "GB as ",
            {
              "Fn::Select": [
                "2",
                {
                  "Ref": "Volume7"
                }
              ]
            },
            " mounted on ",
            {
              "Fn::Select": [
                "3",
                {
                  "Ref": "Volume7"
                }
              ]
            }
          ]
        ]
      },
      "Description": "Volume7"
    },
    "Volume8": {
      "Condition": "NeedsVolume8",
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume8"
                }
              ]
            },
            "GB as ",
            {
              "Fn::Select": [
                "2",
                {
                  "Ref": "Volume8"
                }
              ]
            },
            " mounted on ",
            {
              "Fn::Select": [
                "3",
                {
                  "Ref": "Volume8"
                }
              ]
            }
          ]
        ]
      },
      "Description": "Volume8"
    },
    "Volume9": {
      "Condition": "NeedsVolume9",
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume9"
                }
              ]
            },
            "GB as ",
            {
              "Fn::Select": [
                "2",
                {
                  "Ref": "Volume9"
                }
              ]
            },
            " mounted on ",
            {
              "Fn::Select": [
                "3",
                {
                  "Ref": "Volume9"
                }
              ]
            }
          ]
        ]
      },
      "Description": "Volume9"
    },
    "Volume10": {
      "Condition": "NeedsVolume10",
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume10"
                }
              ]
            },
            "GB as ",
            {
              "Fn::Select": [
                "2",
                {
                  "Ref": "Volume10"
                }
              ]
            },
            " mounted on ",
            {
              "Fn::Select": [
                "3",
                {
                  "Ref": "Volume10"
                }
              ]
            }
          ]
        ]
      },
      "Description": "Volume10"
    },
    "Volume11": {
      "Condition": "NeedsVolume11",
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume11"
                }
              ]
            },
            "GB as ",
            {
              "Fn::Select": [
                "2",
                {
                  "Ref": "Volume11"
                }
              ]
            },
            " mounted on ",
            {
              "Fn::Select": [
                "3",
                {
                  "Ref": "Volume11"
                }
              ]
            }
          ]
        ]
      },
      "Description": "Volume11"
    },
    "Volume12": {
      "Condition": "NeedsVolume12",
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "Volume12"
                }
              ]
            },
            "GB as ",
            {
              "Fn::Select": [
                "2",
                {
                  "Ref": "Volume12"
                }
              ]
            },
            " mounted on ",
            {
              "Fn::Select": [
                "3",
                {
                  "Ref": "Volume12"
                }
              ]
            }
          ]
        ]
      },
      "Description": "Volume12"
    }
  }
}
